<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.65.3" />

<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">



<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>存储切换M3方式，强烈建议 | Nightingale</title><meta property="og:title" content="存储切换M3方式，强烈建议" />
<meta property="og:description" content="夜莺在v3版本引入了m3作为后端存储，m3在uber声称存储了66亿监控指标，非常强悍，建议尝试
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/en/v4/docs/install/m3db/" />
<meta property="article:published_time" content="2020-02-19T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-02-19T00:00:00+00:00" /><meta property="og:site_name" content="Nightingale" />
<meta itemprop="name" content="存储切换M3方式，强烈建议">
<meta itemprop="description" content="夜莺在v3版本引入了m3作为后端存储，m3在uber声称存储了66亿监控指标，非常强悍，建议尝试
">
<meta itemprop="datePublished" content="2020-02-19T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-02-19T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="305">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="存储切换M3方式，强烈建议"/>
<meta name="twitter:description" content="夜莺在v3版本引入了m3作为后端存储，m3在uber声称存储了66亿监控指标，非常强悍，建议尝试
"/>





<link rel="preload" href="/scss/main.min.2578e97f9d8843a49edf8fa01aaed62984681a97b7c0443d1569efd5033a2a1a.css" as="style">
<link href="/scss/main.min.2578e97f9d8843a49edf8fa01aaed62984681a97b7c0443d1569efd5033a2a1a.css" rel="stylesheet" integrity="">


<script
  src="https://s3-gz01.didistatic.com/n9e-pub/js/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>



  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/en/">
		<span class="navbar-logo">
			<img src="https://s3-gz01.didistatic.com/n9e-pub/n9e-book/logo/n9e-logo-white.png" width="140">
		
	</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/en/en/docs/" ><span>Documentation</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link active" href="/en/v4/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/en/v4/blog/" ><span>博客</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/en/en/community/" ><span>Community</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/en/v4/community/" ><span>社区</span></a>
			</li>
			
			
			
			<li class="nav-item dropdown d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	English
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/v4/">v4版本</a>
	
	<a class="dropdown-item" href="/">v5版本</a>
	
</div>
			</li>
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
</div>
</nav>

    </header>
    <div class="container-fluid td-default td-outer">
      <main role="main" class="td-main">
        

<p>初期可以使用单机版m3db做测试，有了解之后上生产建议使用集群版。用了m3之后，原来的index模块和tsdb模块就可以不用了。m3相比原来的index+tsdb的方案，优劣势是什么？</p>
<p>优点：</p>
<ul>
<li>对硬盘IO要求没那么高了，普通机械硬盘也能抗比较大的量</li>
<li>存原始数据，不降采样了，追问题的时候更方便，当然了，存储的数据时长就变短了，相同硬盘空间大小，比如原来rrd可以存1年的历史趋势数据，m3可能只能存1个月</li>
<li>扩容非常方便，直接加m3dbnode即可，index+tsdb的方案使用migrate配置，扩容不易</li>
<li>容灾更好了，可以设置3副本，如果集群部署了3台机器，挂掉一台机器完全没有影响</li>
<li>索引避免了原来index+tsdb的单点容量问题，原来index虽然是可以部署为集群，但是集群里每个节点都是全量索引</li>
</ul>
<p>劣势：</p>
<ul>
<li>硬盘空间占用大，毕竟存储原始数据嘛，一般生产环境建议存1个月，再久也尽量不要超过3个月，当然了，要监控的设备比较少，部署m3的机器硬盘又比较大，那另当别论</li>
<li>内存占用比较多，一般配置是最近两个小时的数据要缓存在内存里，所以比较吃内存，好在内存现在也便宜了，一台机器动不动128G、256G的</li>
</ul>
<h1 id="通用改动">通用改动</h1>
<p>即不管是单机版m3还是集群版，对于n9e来说都要修改的一些配置。</p>
<h2 id="修改-transfer-配置">修改 transfer 配置</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">backend</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">datasource</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;m3db&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 选择 m3db 为索引和存储源</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">m3db</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 开启 m3db</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;m3db&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;test&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">seriesLimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">docsLimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">daysLimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#8f5902;font-style:italic"># 查询时的最大时间限制</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 读写数据时一致性检查的等级，请参考官方文档</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># https://m3db.github.io/m3/m3db/architecture/consistencylevels/</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">writeConsistencyLevel</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;majority&#34;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># one|majority|all</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">readConsistencyLevel</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;unstrict_majority&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># one|unstrict_majority|majority|all</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">config</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">service</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># KV environment, zone, and service from which to write/read KV data (placement</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># and configuration). Leave these as the default values unless you know what</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># you&#39;re doing. 请与m3.dbnode 的配置保持一致</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>default_env<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">zone</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>embedded<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">service</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>m3db<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># 以下是 etcd 的配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">etcdClusters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:bold">zone</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>embedded<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># 单机版的话，endpoints这部分一定要配置为127.0.0.1的</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">endpoints</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#0000cf;font-weight:bold">127.0.0.1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">2379</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># 单机版不需要搞证书，单机版的etcd是内嵌在m3dbnode里的，把tls相关的这4行注释掉</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">tls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">caCrtPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>/opt/run/etcd/certs/root/ca.pem<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">crtPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>/opt/run/etcd/certs/output/etcd-client.pem<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">keyPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>/opt/run/etcd/certs/output/etcd-client-key.pem<span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h2 id="修改-monapi-配置">修改 monapi 配置</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#8f5902;font-style:italic"># 新增 indexMod 配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">indexMod</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>transfer<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">logger</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>logs/monapi<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">level</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>INFO<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">keepHours</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>...<span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h2 id="修改-judge-配置">修改 judge 配置</h2>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">query</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">indexMod</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>transfer<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">connTimeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">callTimeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">indexCallTimeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>...<span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h2 id="修改nginx配置">修改nginx配置</h2>
<p>使用M3DB替代之前的自研index+rrd的方案，原来的index模块和tsdb模块就可以下掉了，nginx里index相关的配置需要改动，原来的配置：</p>
<pre><code>location /api/index {
    proxy_pass http://n9e.index;
}
</code></pre><p>改成：</p>
<pre><code>location /api/index {
    proxy_pass http://n9e.transfer;
}
</code></pre><p>相当于，使用M3DB做后端的存储的话，transfer模块会承接索引请求，转发给M3处理</p>
<h2 id="m3官方资料">M3官方资料</h2>
<ul>
<li><a href="https://operator.m3db.io/getting_started/installation/">installation</a></li>
<li><a href="https://m3db.github.io/m3/how_to/single_node/">single_node</a></li>
<li><a href="https://m3db.github.io/m3/how_to/cluster_hard_way/">cluster_hard_way</a></li>
</ul>
<p>建议大伙尽量还是去官方了解一下M3，uber声称他们用m3存储了66亿指标，真的非常牛逼。如果不想深究，想先用起来测试，请参考下面的方法</p>
<h2 id="单机版m3">单机版M3</h2>
<p>这个试用于单机测试场景，所有夜莺服务端组件都部署在一台机器上，特别是transfer和m3要部署在一台机器上的场景，用来测试或者应对小规模场景，足够了</p>
<h3 id="安装方法">安装方法</h3>
<p>单机安装包<a href="https://s3-gz01.didistatic.com/n9e-pub/tarball/m3dbnode-single-v0.0.1.tar.gz">m3dbnode-single-v0.0.1.tar.gz</a> ，解包之后有个README是安装文档，主要是两个操作步骤：</p>
<p>1、解包之后执行./scripts/install.sh，这个脚本在centos7上面测试ok，用了systemd的方式托管进程，大家可以打开看看脚本内容
2、调用m3的接口，创建<code>/api/v1/database/create</code>创建database，README里有个例子，retentionTime是数据存储时长，测试阶段可以设置为48h，存2天，足够了</p>
<h3 id="检查状态">检查状态</h3>
<p>因为是systemd托管的，所以 <code>systemctl status m3dbnode</code> 即可查看进程状态。机器重启之后如果希望进程自动拉起，记得执行 <code>systemctl enable m3dbnode</code></p>
<h2 id="集群版m3">集群版M3</h2>
<p><a href="https://s3-gz01.didistatic.com/n9e-pub/tarball/m3db-install-v0.0.2.tar.gz">m3db-install-v0.0.2.tar.gz</a> </p>
<h3 id="配置">配置</h3>
<h4 id="etcd证书">etcd证书</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#8f5902;font-style:italic"># 修改 ./etcd/certs/config/hosts-etcd</span>
<span style="color:#8f5902;font-style:italic"># 填写etcd的机器列表</span>

<span style="color:#8f5902;font-style:italic"># 生成证书</span>
<span style="color:#204a87">cd</span> etcd/certs
./reinit-root-ca.sh
./update-etcd-client-certs.sh
./update-etcd-server-certs.sh
</code></pre></div><h4 id="m3db配置">m3db配置</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#8f5902;font-style:italic"># 修改 ./m3db/etc/m3dbnode.yml</span>
db:
  config:
    service:
      etcdClusters:
        - zone: embedded_env
          endpoints:
            - 10.255.0.146:2379  <span style="color:#8f5902;font-style:italic"># 这里需要修改 etcd 节点信息</span>
            - 10.255.0.129:2379
</code></pre></div><h4 id="分发安装">分发安装</h4>
<p>为了避免麻烦，用来发起m3安装的机器，和目标的3台机器尽量不要复用</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">. ./functions.sh

<span style="color:#8f5902;font-style:italic"># set hosts</span>
<span style="color:#000">hosts</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;{node1} {node2} {node3}&#34;</span>

<span style="color:#8f5902;font-style:italic"># sync etcd,m3db to hosts</span>
sync

<span style="color:#8f5902;font-style:italic"># install</span>
install

<span style="color:#8f5902;font-style:italic"># status</span>
status
</code></pre></div><h4 id="安装之后的路径">安装之后的路径</h4>
<pre><code># database path
/home/etcd
/home/m3db
/home/m3kv

# config path
/etc/etcd/
/etc/m3db/
</code></pre><h4 id="初始化-m3dbnode-database">初始化 m3dbnode database</h4>
<p>修改 ./m3db/scripts/01-create-db.sh 后，执行：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -X POST http://localhost:7201/api/v1/database/create -d <span style="color:#4e9a06">&#39;{
</span><span style="color:#4e9a06">  &#34;type&#34;: &#34;cluster&#34;,
</span><span style="color:#4e9a06">  &#34;namespaceName&#34;: &#34;default&#34;,
</span><span style="color:#4e9a06">  &#34;retentionTime&#34;: &#34;2160h&#34;,
</span><span style="color:#4e9a06">  &#34;numShards&#34;: &#34;64&#34;,
</span><span style="color:#4e9a06">  &#34;replicationFactor&#34;: &#34;3&#34;,
</span><span style="color:#4e9a06">  &#34;hosts&#34;: [
</span><span style="color:#4e9a06">        {
</span><span style="color:#4e9a06">            &#34;id&#34;: &#34;10-255-0-146&#34;,
</span><span style="color:#4e9a06">            &#34;isolationGroup&#34;: &#34;group1&#34;,
</span><span style="color:#4e9a06">            &#34;zone&#34;: &#34;embedded&#34;,
</span><span style="color:#4e9a06">            &#34;weight&#34;: 100,
</span><span style="color:#4e9a06">            &#34;address&#34;: &#34;10.255.0.146&#34;,
</span><span style="color:#4e9a06">            &#34;port&#34;: 9000
</span><span style="color:#4e9a06">        },
</span><span style="color:#4e9a06">        {
</span><span style="color:#4e9a06">            &#34;id&#34;: &#34;10-255-0-129&#34;,
</span><span style="color:#4e9a06">            &#34;isolationGroup&#34;: &#34;group2&#34;,
</span><span style="color:#4e9a06">            &#34;zone&#34;: &#34;embedded&#34;,
</span><span style="color:#4e9a06">            &#34;weight&#34;: 100,
</span><span style="color:#4e9a06">            &#34;address&#34;: &#34;10.255.0.129&#34;,
</span><span style="color:#4e9a06">            &#34;port&#34;: 9000
</span><span style="color:#4e9a06">        },
</span><span style="color:#4e9a06">        {
</span><span style="color:#4e9a06">            &#34;id&#34;: &#34;10-255-0-137&#34;,
</span><span style="color:#4e9a06">            &#34;isolationGroup&#34;: &#34;group3&#34;,
</span><span style="color:#4e9a06">            &#34;zone&#34;: &#34;embedded&#34;,
</span><span style="color:#4e9a06">            &#34;weight&#34;: 100,
</span><span style="color:#4e9a06">            &#34;address&#34;: &#34;10.255.0.137&#34;,
</span><span style="color:#4e9a06">            &#34;port&#34;: 9000
</span><span style="color:#4e9a06">        }
</span><span style="color:#4e9a06">    ]
</span><span style="color:#4e9a06">}&#39;</span>
</code></pre></div><ul>
<li>hosts[0].id: 这是机器节点的标识，默认情况下，用的是机器的hostname； 取决于m3dbnode.yml: db.hostID.resolver如何配置</li>
<li>retentionTime: 数据保存时长，默认是90天，磁盘空间不够的话，建议改成8天，即192，不是7天，是担心后面可能有周环比的看图需要</li>
<li>numShards: 如果是单机测试，这里改成8，如果是3台机器可以用64，如果有更多机器，可以参照下一章节来定义这个数量</li>
<li>replicationFactor: 如果单节点就改成1即可</li>
</ul>
<h3 id="扩展阅读">扩展阅读</h3>
<p>节点数量， 建议至少3台机器，数据复制3份(RF)，参考  <a href="https://m3db.github.io/m3/operational_guide/replication_and_deployment_in_zones/">replication_and_deployment_in_zones</a></p>
<table>
<thead>
<tr>
<th>Replica Factor</th>
<th>Quorum Size</th>
<th>Failure Tolerance</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>4</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>6</td>
<td>4</td>
<td>2</td>
</tr>
<tr>
<td>7</td>
<td>4</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>数据分片数量，根据未来的规模配置，参考 <a href="https://m3db.github.io/m3/operational_guide/placement_configuration/">placement_configuration</a></p>
<table>
<thead>
<tr>
<th>Number of Nodes</th>
<th>Number of Shards</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td>64</td>
</tr>
<tr>
<td>6</td>
<td>128</td>
</tr>
<tr>
<td>12</td>
<td>256</td>
</tr>
<tr>
<td>24</td>
<td>512</td>
</tr>
<tr>
<td>48</td>
<td>1024</td>
</tr>
<tr>
<td>128+</td>
<td>4096</td>
</tr>
</tbody>
</table>



      </main>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Wechat" aria-label="Wechat">
    <a class="text-white" target="_blank" href="https://s3-gz01.didistatic.com/n9e-pub/image/n9e-invite.png">
      <i class="fab fa-weixin"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Email" aria-label="Email">
    <a class="text-white" target="_blank" href="mailto:nightingale@didiglobal.com">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" href="https://github.com/didi/nightingale">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" href="https://n9e.slack.com/">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 DiDi&#39;s Nightingale team All Rights Reserved</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://s3-gz01.didistatic.com/n9e-pub/js/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://s3-gz01.didistatic.com/n9e-pub/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>







<script src="/js/main.min.29b0315468c00226fa6f4556a9cebc0ac4fe1ce1457a01b22c0a06b329877383.js" integrity="sha256-KbAxVGjAAib6b0VWqc68CsT&#43;HOFFegGyLAoGsymHc4M=" crossorigin="anonymous"></script>



  </body>
</html>