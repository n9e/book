<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.65.3" />

<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">



<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Plugin mechanism  | Nightingale</title><meta property="og:title" content="Plugin mechanism " />
<meta property="og:description" content="Nightingale can designate a certain directory as a plug-in directory, read the files in this directory that conform to a specific format, and execute it as a plug-in, thereby expanding the collector&#39;s ability
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/en/en/docs/usage/plugin/" />
<meta property="article:published_time" content="2020-02-19T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-04-23T14:35:32+08:00" /><meta property="og:site_name" content="Nightingale" />
<meta itemprop="name" content="Plugin mechanism ">
<meta itemprop="description" content="Nightingale can designate a certain directory as a plug-in directory, read the files in this directory that conform to a specific format, and execute it as a plug-in, thereby expanding the collector&#39;s ability
">
<meta itemprop="datePublished" content="2020-02-19T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-04-23T14:35:32&#43;08:00" />
<meta itemprop="wordCount" content="506">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Plugin mechanism "/>
<meta name="twitter:description" content="Nightingale can designate a certain directory as a plug-in directory, read the files in this directory that conform to a specific format, and execute it as a plug-in, thereby expanding the collector&#39;s ability
"/>





<link rel="preload" href="/scss/main.min.2578e97f9d8843a49edf8fa01aaed62984681a97b7c0443d1569efd5033a2a1a.css" as="style">
<link href="/scss/main.min.2578e97f9d8843a49edf8fa01aaed62984681a97b7c0443d1569efd5033a2a1a.css" rel="stylesheet" integrity="">


<script
  src="https://s3-gz01.didistatic.com/n9e-pub/js/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>



  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/en/">
		<span class="navbar-logo">
			<img src="https://s3-gz01.didistatic.com/n9e-pub/n9e-book/logo/n9e-logo-white.png" width="140">
		
	</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link active" href="/en/en/docs/" ><span class="active">Documentation</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/en/v4/docs/" ><span>文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/en/v4/blog/" ><span>博客</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/en/en/community/" ><span>Community</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/en/v4/community/" ><span>社区</span></a>
			</li>
			
			
			
			<li class="nav-item dropdown d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	English
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/v4/">v4版本</a>
	
	<a class="dropdown-item" href="/">v5版本</a>
	
</div>
			</li>
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
</div>
</nav>

    </header>
    <div class="container-fluid td-default td-outer">
      <main role="main" class="td-main">
        

<p>Although the collector component has a built-in collection of monitoring indicators, it cannot solve all scenarios, so a plug-in mechanism is provided to extend the function of the collector。</p>
<p>Check the collector configuration file, the plugin directory is configured inside, we only need to put the plugin script in this directory, the collector will automatically detect it, and then run periodically. For the collection of monitoring indicators of the business system, you can put the collection script in the business program release package and go online as the business code goes online (put the script in the collector&rsquo;s plugin directory when going online), and upgrade as the business code upgrades. As the business code goes offline and goes offline (remove the script from the collector&rsquo;s plugin directory when going offline), it will be easier to manage.</p>
<p>For plugins, there are several requirements:</p>
<ul>
<li>The plugin script must have executable permissions, remember to execute chmod + x after the script is deployed</li>
<li>The plugin script can be sh, py, pl, rb, or even binary, as long as there is a runtime environment on the machine</li>
<li>Plugin script naming: <code>$ {step} _xx.xx</code>, such as<code> 20_uptime.sh</code>, <code>$ {step}</code> is telling the collector how often to run</li>
<li>Files or directories in the plugin directory that are not in the <code>$ {step} _xx.xx</code> naming format can exist, it does not matter, the collector will not recognize it as a plugin</li>
<li>After the plugin is executed, a json array must be output on stdout, and the collector will intercept this output and parse it as a monitoring indicator for reporting</li>
<li>If the plug-in executes an error, the error message should be printed to stderr, not stdout</li>
</ul>
<p>The following is an example of a plugin written by shell 20_uptime.sh:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">duration</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>cat /proc/uptime <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $1}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
<span style="color:#000">localip</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>ifconfig <span style="color:#4e9a06">`</span>route<span style="color:#000;font-weight:bold">|</span>grep <span style="color:#4e9a06">&#39;^default&#39;</span><span style="color:#000;font-weight:bold">|</span>awk <span style="color:#4e9a06">&#39;{print $NF}&#39;</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">|</span>grep inet<span style="color:#000;font-weight:bold">|</span>awk <span style="color:#4e9a06">&#39;{print $2}&#39;</span><span style="color:#000;font-weight:bold">|</span>awk -F <span style="color:#4e9a06">&#39;:&#39;</span> <span style="color:#4e9a06">&#39;{print $NF}&#39;</span><span style="color:#000;font-weight:bold">|</span>head -n 1<span style="color:#204a87;font-weight:bold">)</span>
<span style="color:#000">step</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>basename <span style="color:#000">$0</span><span style="color:#000;font-weight:bold">|</span>awk -F<span style="color:#4e9a06">&#39;_&#39;</span> <span style="color:#4e9a06">&#39;{print $1}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
<span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#39;[
</span><span style="color:#4e9a06">    {
</span><span style="color:#4e9a06">        &#34;endpoint&#34;: &#34;&#39;</span><span style="color:#4e9a06">${</span><span style="color:#000">localip</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#39;&#34;,
</span><span style="color:#4e9a06">        &#34;tags&#34;: &#34;&#34;,
</span><span style="color:#4e9a06">        &#34;timestamp&#34;: &#39;</span><span style="color:#204a87;font-weight:bold">$(</span>date +%s<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#39;,
</span><span style="color:#4e9a06">        &#34;metric&#34;: &#34;sys.uptime.duration&#34;,
</span><span style="color:#4e9a06">        &#34;value&#34;: &#39;</span><span style="color:#4e9a06">${</span><span style="color:#000">duration</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#39;,
</span><span style="color:#4e9a06">        &#34;step&#34;: &#39;</span><span style="color:#4e9a06">${</span><span style="color:#000">step</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#39;
</span><span style="color:#4e9a06">    }
</span><span style="color:#4e9a06">]&#39;</span>
</code></pre></div><p>The following is an example of a plugin written in python 20_plugin_status.py:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#8f5902;font-style:italic">#!/usr/bin/env python</span>
<span style="color:#8f5902;font-style:italic"># -*- coding: utf-8 -*-</span>

<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">time</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">commands</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">json</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">sys</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">os</span>

<span style="color:#000">items</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span>


<span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">collect_myself_status</span><span style="color:#000;font-weight:bold">():</span>
    <span style="color:#000">item</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{}</span>
    <span style="color:#000">item</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;metric&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;plugin.myself.status&#34;</span>
    <span style="color:#000">item</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
    <span style="color:#000">item</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;tags&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span>
    <span style="color:#000">items</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">item</span><span style="color:#000;font-weight:bold">)</span>


<span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">():</span>
    <span style="color:#000">code</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">endpoint</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">commands</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">getstatusoutput</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#4e9a06">&#34;timeout 1 ifconfig `route|grep &#39;^default&#39;|awk &#39;{print $NF}&#39;`|grep inet|awk &#39;{print $2}&#39;|awk -F &#39;:&#39; &#39;{print $NF}&#39;|head -n 1&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">code</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span>
        <span style="color:#000">sys</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stderr</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cannot get local ip&#39;</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#204a87;font-weight:bold">return</span>

    <span style="color:#000">timestamp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">())</span>
    <span style="color:#000">plugin_name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">basename</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sys</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span>
    <span style="color:#000">step</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plugin_name</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;_&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span>

    <span style="color:#000">collect_myself_status</span><span style="color:#000;font-weight:bold">()</span>

    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">item</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">items</span><span style="color:#000;font-weight:bold">:</span>
        <span style="color:#000">item</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;endpoint&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">endpoint</span>
        <span style="color:#000">item</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;timestamp&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">timestamp</span>
        <span style="color:#000">item</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;step&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">step</span>

    <span style="color:#204a87;font-weight:bold">print</span> <span style="color:#000">json</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dumps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">items</span><span style="color:#000;font-weight:bold">)</span>


<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__main__&#34;</span><span style="color:#000;font-weight:bold">:</span>
    <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span>
</code></pre></div><p>In addition, the Open-Falcon community can see that many third-party indicator collectors do not exist as plug-in mechanisms. They are all in the form of independent daemon processes or cron scripts. This method is similar to plug-ins, except that you need to monitor the collection yourself Pushing data to the collector or transfer is also a kind of generalized plug-in.</p>



      </main>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Wechat" aria-label="Wechat">
    <a class="text-white" target="_blank" href="https://s3-gz01.didistatic.com/n9e-pub/image/n9e-invite.png">
      <i class="fab fa-weixin"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Email" aria-label="Email">
    <a class="text-white" target="_blank" href="mailto:nightingale@didiglobal.com">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" href="https://github.com/didi/nightingale">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" href="https://n9e.slack.com/">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 DiDi&#39;s Nightingale team All Rights Reserved</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://s3-gz01.didistatic.com/n9e-pub/js/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://s3-gz01.didistatic.com/n9e-pub/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>







<script src="/js/main.min.29b0315468c00226fa6f4556a9cebc0ac4fe1ce1457a01b22c0a06b329877383.js" integrity="sha256-KbAxVGjAAib6b0VWqc68CsT&#43;HOFFegGyLAoGsymHc4M=" crossorigin="anonymous"></script>



  </body>
</html>