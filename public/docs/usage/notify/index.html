<!doctype html>
<html lang="v5" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.65.3" />

<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">




<link rel="icon" href="data:null;base64,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" />
<title>告警通知 | Nightingale</title><meta property="og:title" content="告警通知" />
<meta property="og:description" content="告警消息发送，为了适配各种媒介，我们直接使用python脚本 etc/script/notify.py 来对接，本文将对告警信息发送的配置方式及notify.py原理进行介绍
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/docs/usage/notify/" />
<meta property="article:published_time" content="2021-04-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-07-06T11:32:42+08:00" /><meta property="og:site_name" content="Nightingale" />
<meta itemprop="name" content="告警通知">
<meta itemprop="description" content="告警消息发送，为了适配各种媒介，我们直接使用python脚本 etc/script/notify.py 来对接，本文将对告警信息发送的配置方式及notify.py原理进行介绍
">
<meta itemprop="datePublished" content="2021-04-01T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-07-06T11:32:42&#43;08:00" />
<meta itemprop="wordCount" content="94">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="告警通知"/>
<meta name="twitter:description" content="告警消息发送，为了适配各种媒介，我们直接使用python脚本 etc/script/notify.py 来对接，本文将对告警信息发送的配置方式及notify.py原理进行介绍
"/>





<link rel="preload" href="/scss/main.min.2578e97f9d8843a49edf8fa01aaed62984681a97b7c0443d1569efd5033a2a1a.css" as="style">
<link href="/scss/main.min.2578e97f9d8843a49edf8fa01aaed62984681a97b7c0443d1569efd5033a2a1a.css" rel="stylesheet" integrity="">


<script
  src="https://s3-gz01.didistatic.com/n9e-pub/js/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>



    <title>告警通知 | Nightingale</title>
  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo">
			<img src="https://s3-gz01.didistatic.com/n9e-pub/image/n9e-logo-v5-white.png">
			<span style="line-height: 32px;vertical-align:middle;font-weight: 700;">Nightingale</span>
		
	</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link active" href="/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/community/" ><span>社区</span></a>
			</li>
			
			
			
			<li class="nav-item dropdown d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	v5版本
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/v4/">v4版本</a>
	
</div>
			</li>
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav pt-2 pl-4" id="td-section-nav">
    
    <div class="nav-item dropdown d-block d-lg-none">
      

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	v5版本
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/v4/">v4版本</a>
	
</div>
    </div>
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">文档</a>
  </li>
  <ul>
    <li class="collapse show" id="docs">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/intro/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">夜莺介绍</a>
  </li>
  <ul>
    <li class="collapse " id="docsintro">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/install/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">安装部署</a>
  </li>
  <ul>
    <li class="collapse " id="docsinstall">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/usage/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">使用说明</a>
  </li>
  <ul>
    <li class="collapse show" id="docsusage">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsusagemenus" href="/docs/usage/menus/">功能简介</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsusageport" href="/docs/usage/port/">端口监控</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsusageproc" href="/docs/usage/proc/">进程监控</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsusageplugin" href="/docs/usage/plugin/">插件监控</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsusagelogmon" href="/docs/usage/logmon/">日志监控</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page  active" id="m-docsusagenotify" href="/docs/usage/notify/">告警通知</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/appendix/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">附录</a>
  </li>
  <ul>
    <li class="collapse " id="docsappendix">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsappendixdatamodel" href="/docs/appendix/datamodel/">DataModel</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsappendixfuncs" href="/docs/appendix/funcs/">告警函数</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsappendixapi" href="/docs/appendix/api/">API调用</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsappendixnginx" href="/docs/appendix/nginx/">配置nginx</a>
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            






<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">





<a href="https://github.com/n9e/book/edit/master/content/v5/docs/usage/notify.md" target="_blank"><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/n9e/book/issues/new?title=%e5%91%8a%e8%ad%a6%e9%80%9a%e7%9f%a5" target="_blank"><i class="fab fa-github fa-fw"></i> 提交文档问题</a>


<a href="https://github.com/didi/nightingale/issues/new" target="_blank"><i class="fas fa-tasks fa-fw"></i> 提交项目问题</a>

</div>






<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#notifypy原理">notify.py原理</a></li>
        <li><a href="#邮件发送配置">邮件发送配置</a></li>
        <li><a href="#钉钉群消息发送配置">钉钉群消息发送配置</a></li>
        <li><a href="#支持其他通知媒介">支持其他通知媒介</a></li>
      </ul>
    </li>
  </ul>
</nav>




<div style="">
	<img src="https://s3-gz01.didistatic.com/n9e-pub/image/n9e-invite.png" width="180" alt="n9e-helper"/>
</div>



          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		










<li class="breadcrumb-item" >
	<a href="/docs/">文档</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/usage/">使用说明</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="/docs/usage/notify/">告警通知</a>
</li>

	</ol>
</nav	>

            
<div class="td-content">
	<h1>告警通知</h1>
	<div class="lead">告警消息发送，为了适配各种媒介，我们直接使用python脚本 etc/script/notify.py 来对接，本文将对告警信息发送的配置方式及notify.py原理进行介绍</div>
	<p>在《<a href="https://n9e.didiyun.com/docs/intro/">夜莺介绍</a>》一文中，我们介绍了夜莺的告警信息通知 notify.py 脚本来实现的，本文详细讲解下 notify.py 的实现原理，以及如何在页面上配置用户的联系方式，来支持多种通知渠道</p>
<h3 id="notifypy原理">notify.py原理</h3>
<p>因为通知渠道多种多样（短信、邮件、电话、微信、钉钉、slack、飞书、jira、公司自有im等等），夜莺没法内置支持所有的通知渠道，所以需要一个非常灵活易于扩展的方式，最灵活易于扩展的方式显然是代码。所以夜莺发送告警通知的时候，会使用notify.py脚本来发送，这个脚本放在etc/script目录下，大家可以自行修改。n9e-server进程生成告警事件之后，会把告警事件的内容整理成一个json字符串，通过stdin的方式传给notify.py，所有的发送逻辑都在notify.py里完成。各位运维研发的小伙伴，对于阅读并修改python脚本应该是比较得心应手的，所以大胆改造这个脚本吧，欢迎PR，让notify.py支持更多发送媒介。</p>
<p>notify.py收到告警信息之后，会将告警格式化为一个有缩进的json写入一个临时文件，为后续排查问题使用，临时文件的命名规则是 <code>${rule_id}_${event_id}_${trigger_time}</code>。这个临时文件会放到哪个目录呢？请阅读notify.py自己找答案。所以，只要看到临时文件的生成，就说明告警逻辑是没有问题的。如果有某个媒介没有通知成功，那就要仔细查看notify.py的代码了。如果觉得notify.py的代码也没问题，那就要怀疑通道媒介是否做了限制之类的，比如钉钉，就有每分钟发送条数的限制。</p>
<p>另外notify.py具体如何支持多种通知媒介呢？其实要想把消息发出去，只要知道发送对象的联系方式和发送通道就可以了，发送对象可以从json对象的event.users中获取，发送通道可以从 event.notify_channels 中获取，具体如何配置，下面会详细介绍。</p>
<h3 id="邮件发送配置">邮件发送配置</h3>
<p>目前notify.py 提供了发送邮件和钉钉群消息的能力，下面介绍下如何接入使用。发送邮件的话，首先需要修改notify.py中的邮件网关配置：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">mail_host</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;smtp.163.com&#34;</span>
<span style="color:#000">mail_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">994</span>
<span style="color:#000">mail_user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;ulricqin&#34;</span>
<span style="color:#000">mail_pass</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;password&#34;</span>
<span style="color:#000">mail_from</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;ulricqin@163.com&#34;</span>
</code></pre></div><p>修改完成之后，在个人信息-邮箱的地方，填上自己的邮箱</p>
<p><img src="https://s3-gz01.didistatic.com/n9e-pub/image/n9e-v5-user-profile.png" alt="image.png"></p>
<p>如果邮件网关配置的没问题的话，当告警事件触发后，就可以收到告警邮件通知了。如果没有收到，可以依次检查页面上是否生成未恢复的告警事件，检查上文提到的临时文件是否生成，检查邮件网关配置，检查邮件发送代码逻辑，也可以自己写个邮件测试小脚本测试下邮件发送的方法逻辑。</p>
<h3 id="钉钉群消息发送配置">钉钉群消息发送配置</h3>
<p>夜莺提供了支持多种消息媒介的能力，除了内置的邮箱和手机号之外，在 server.yml 中，可以配置额外的通知媒介，配置如下</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">contactKeys</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">label</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Wecom Robot Token&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>wecom_robot_token<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">label</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Dingtalk Robot Token&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># User的更多联系方式的下拉框中，钉钉机器人方式的label部分</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>dingtalk_robot_token<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># User的更多联系方式的下拉框中，钉钉机器人方式的key部分，需要和notify.py中获取用户此联系方式的key相同</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    
</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">notifyChannels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- email<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- sms<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- voice<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- dingtalk<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 通知渠道，dingtalk代表要启用钉钉通知媒介</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- wecom<span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>目前默认配置了微信机器人和钉钉机器人，如果想要增加其他联系方式，修改配置文件，然后重启 n9e-server 即可。重启服务端之后，在创建用户的时候，就可以给用户添加在server.yml中配置的联系方式了，如果是发送钉钉群消息的话，可以选择Dingtalk Robot Token</p>
<p><img src="https://s3-gz01.didistatic.com/n9e-pub/image/n9e-v5-user-contacts.png" alt="image.png"></p>
<p>假设我们在系统里创建了一个虚拟用户：dingtalk-x，并且把钉钉的token配置到了dingtalk-x的Dingtalk Robot Token字段上。那当我们把dingtalk-x或者dingtalk-x所在的团队添加到某个告警策略的接收者之后，当告警触发的时候，对应的钉钉机器人所在的钉钉群就会收到告警信息，如下</p>
<p><img src="https://s3-gz01.didistatic.com/n9e-pub/image/n9e-v5-dingtalk-notice.png" alt="image.png"></p>
<h3 id="支持其他通知媒介">支持其他通知媒介</h3>
<p>这里以发送微信群消息为例，主要分三个步骤。</p>
<p>第一，在 server.yml 中配置新的通知媒介联系字段和通知渠道，然后重启服务器</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">contactKeys</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">label</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Wecom Robot Token&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># User的更多联系方式的下拉框中，微信机器人方式的label部分</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>wecom_robot_token<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># User的更多联系方式的下拉框中，微信机器人方式的key部分，需要和notify.py中获取用户此联系方式的key相同</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">label</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Dingtalk Robot Token&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>dingtalk_robot_token<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">notifyChannels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- email<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- sms<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- voice<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- dingtalk<span style="color:#f8f8f8;text-decoration:underline"> 
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- wecom<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 通知渠道，wecom代表要启用企业微信通知媒介</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>第二，在创建用户的时候，以添加微信群消息举例，在更多联系方式的地方，把 Wecom Robot Token 字段的值配上（配置为企业微信机器人的token），之后在notify.py中就可以通过user的 <code>contacts.get(&quot;wecom_robot_token&quot;, &quot;&quot;)</code> 拿到该用户的企业微信token。</p>
<p><img src="https://s3-gz01.didistatic.com/n9e-pub/image/n9e-v5-wecom-notice.png" alt="image.png"></p>
<p>第三， 到这一步，新通知媒介的方法名称知道了（notifyChannels.xxx），用户的联系方式也知道了(<code>user.contacts[contactKeys.key]</code>)，就可以补充notify.py中send_xxx的方法了，脚本完成补充之后，在个人信息页面，配置更多联系方式，就可以收到对应的消息了</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#5c35cc;font-weight:bold">@classmethod</span>
<span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">send_wecom</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">cls</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">payload</span><span style="color:#000;font-weight:bold">):</span>
    <span style="color:#204a87;font-weight:bold">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;send_wecom&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 补充发送逻辑</span>
</code></pre></div><p><img src="https://s3-gz01.didistatic.com/n9e-pub/image/n9e-v5-user-profile-dingtalk.png" alt="image.png"></p>

	
	
	<div class="text-muted mt-5 pt-3 border-top">

<h5>诚挚邀请各位小伙伴：</h5>

<p>
一起参与夜莺社区建设，多写一些夜莺的文章，咱们一起把夜莺做成最好用的国产智能监控系统，造福一方。对于不具备开发资源的甲方上帝们，也可联系我们（18612185520，微信同号）寻求技术支持护航服务，贵司业务发展这么快，我们帮你做好监控！
</p>
</div>
</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Wechat" aria-label="Wechat">
    <a class="text-white" target="_blank" href="https://s3-gz01.didistatic.com/n9e-pub/image/n9e-invite.png">
      <i class="fab fa-weixin"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Email" aria-label="Email">
    <a class="text-white" target="_blank" href="mailto:nightingale@didiglobal.com">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" href="https://github.com/didi/nightingale">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" href="https://n9e.slack.com/">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 DiDi&#39;s Nightingale team All Rights Reserved</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://s3-gz01.didistatic.com/n9e-pub/js/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://s3-gz01.didistatic.com/n9e-pub/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>







<script src="/js/main.min.29b0315468c00226fa6f4556a9cebc0ac4fe1ce1457a01b22c0a06b329877383.js" integrity="sha256-KbAxVGjAAib6b0VWqc68CsT&#43;HOFFegGyLAoGsymHc4M=" crossorigin="anonymous"></script>



  </body>
</html>